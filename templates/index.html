<!DOCTYPE html>
<html>
<head>
    <title>Dragon Boat Team Attendance</title>
    <!-- Bootstrap CSS -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        .card {
            margin: 5px 0;
        }
        #loading {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 1000;
            font-size: 2em;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>派兜出席表</h1>
        <div class="row align-items-end">
            <div class="col-12 col-md-6">
                <label for="selectDate" class="form-label">Select Date:</label>
                <select id="selectDate" class="form-select" onchange="onDateChange()"></select>
            </div>
        </div>
        <div class="container" style="margin-top: 10px;">
            <div class="row">
                <div class="col-sm" id="bigDragonTableContainer">
                    <table class="table table-sm">
                        <caption class="caption-top">大龍 <span id="bigDragonDate"></span></caption>
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">左</th>
                                <th scope="col">右</th>
                            </tr>
                        </thead>
                        <tbody id="paddleTableBody">
                            <tr><td>0</td><td><select class="form-select" id="left_0"></select></td><td><select class="form-select" id="right_0"></select></td></tr>
                            <tr><td>1</td><td><select class="form-select" id="left_1"></select></td><td><select class="form-select" id="right_1"></select></td></tr>
                            <tr><td>2</td><td><select class="form-select" id="left_2"></select></td><td><select class="form-select" id="right_2"></select></td></tr>
                            <tr><td>3</td><td><select class="form-select" id="left_3"></select></td><td><select class="form-select" id="right_3"></select></td></tr>
                            <tr><td>4</td><td><select class="form-select" id="left_4"></select></td><td><select class="form-select" id="right_4"></select></td></tr>
                            <tr><td>5</td><td><select class="form-select" id="left_5"></select></td><td><select class="form-select" id="right_5"></select></td></tr>
                            <tr><td>6</td><td><select class="form-select" id="left_6"></select></td><td><select class="form-select" id="right_6"></select></td></tr>
                            <tr><td>7</td><td><select class="form-select" id="left_7"></select></td><td><select class="form-select" id="right_7"></select></td></tr>
                            <tr><td>8</td><td><select class="form-select" id="left_8"></select></td><td><select class="form-select" id="right_8"></select></td></tr>
                            <tr><td>9</td><td><select class="form-select" id="left_9"></select></td><td><select class="form-select" id="right_9"></select></td></tr>
                            <tr><td>10</td><td><select class="form-select" id="left_10"></select></td><td><select class="form-select" id="right_10"></select></td></tr>
                            <tr><td>11</td><td><select class="form-select" id="left_11"></select></td><td><select class="form-select" id="right_11"></select></td></tr>
                            <tr><td>12</td><td><select class="form-select" id="left_12"></select></td><td><select class="form-select" id="right_12"></select></td></tr>
                            <tr><td>舵手</td><td><select class="form-select" id="left_helmsman"></select></td><td></td></tr>
                            <tr><td>重量</td><td id="leftWeight">0</td><td id="rightWeight">0</td></tr>
                        </tbody>
                    </table>
                    <button onclick="clearTable('bigDragonTableContainer')" class="btn" style="margin-bottom: 10px; background-color: #33312E; color: #E0E2DB;">清除表格</button>
                    <button onclick="exportTableToImage('bigDragonTableContainer', '大龍')" class="btn" style="margin-bottom: 10px; background-color: #b8bdb5; color: #33312e;">Print Big Dragon</button>
                </div>
                
                <div class="col-sm" id="smallDragonTableContainer">
                    <table class="table table-sm">
                        <caption class="caption-top">小龍 <span id="smallDragonDate"></span></caption>
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">左</th>
                                <th scope="col">右</th>
                            </tr>
                        </thead>
                        <tbody id="smallPaddleTableBody"> 
                            <tr><td>0</td><td><select class="form-select" id="small_left_0"></select></td><td><select class="form-select" id="small_right_0"></select></td></tr>
                            <tr><td>1</td><td><select class="form-select" id="small_left_1"></select></td><td><select class="form-select" id="small_right_1"></select></td></tr>
                            <tr><td>2</td><td><select class="form-select" id="small_left_2"></select></td><td><select class="form-select" id="small_right_2"></select></td></tr>
                            <tr><td>3</td><td><select class="form-select" id="small_left_3"></select></td><td><select class="form-select" id="small_right_3"></select></td></tr>
                            <tr><td>4</td><td><select class="form-select" id="small_left_4"></select></td><td><select class="form-select" id="small_right_4"></select></td></tr>
                            <tr><td>5</td><td><select class="form-select" id="small_left_5"></select></td><td><select class="form-select" id="small_right_5"></select></td></tr>
                            <tr><td>6</td><td><select class="form-select" id="small_left_6"></select></td><td><select class="form-select" id="small_right_6"></select></td></tr>
                            <tr><td>7</td><td><select class="form-select" id="small_left_7"></select></td><td><select class="form-select" id="small_right_7"></select></td></tr>
                            <tr><td>8</td><td><select class="form-select" id="small_left_8"></select></td><td><select class="form-select" id="small_right_8"></select></td></tr>
                            <tr><td>舵手</td><td><select class="form-select" id="small_helmsman"></select></td><td></td></tr>
                            <tr><td>重量</td><td id="smallLeftWeight">0</td><td id="smallRightWeight">0</td></tr>
                        </tbody>
                    </table>
                    <button onclick="clearTable('smallDragonTableContainer')" class="btn" style="margin-bottom: 10px; background-color: #33312E; color: #E0E2DB;">清除表格</button>
                    <button onclick="exportTableToImage('smallDragonTableContainer', '小龍')" class="btn" style="margin-bottom: 10px; background-color: #D2D4C8; color: #33312e;">Print Small Dragon</button>
                </div>
            </div>
        </div>
        <h4 style="padding: 10px;">今日出席人員</h4>
        <div id="attendanceList" class="mt-3"></div>
        <div id="loading" style="display:none;">Loading...</div>
    </div>
    <div class="container mt-3">
        <button onclick="window.location.href='/members'" class="btn" style="background-color: #33312E; color: #E0E2DB;">Member Management</button>
    </div>
    <footer style="background-color: #b8bdb5; margin-top: 20px;">
        <div class="text-center p-3" style="background-color: #00000033;">
            <p>&copy; 2024 Paddle Zelos | Developed by yunjung</p>
        </div>
    </footer>
    <script>
        let currentDate = null;

        async function getAttendance() {
            document.getElementById('loading').style.display = 'block';
            const selectDate = document.getElementById('selectDate').value;
            saveState(currentDate);
            currentDate = selectDate;

            try {
                const response = await fetch('/api/attendance');
                const data = await response.json();

                const dates = data.dates;
                const index = dates.indexOf(selectDate);
                const names = data.names;
                const attendance = data.attendance[index];

                const attendanceList = document.getElementById('attendanceList');
                attendanceList.innerHTML = ''; // Clear previous list

                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';

                names.forEach((name, i) => {
                    if (attendance[i] === '○') {
                        const cardCol = document.createElement('div');
                        cardCol.className = 'col-6 col-md-2'; // Bootstrap column for responsiveness
                        const card = document.createElement('div');
                        card.className = 'card';
                        card.innerHTML = `
                            <div class="card-body">
                                <h5 class="card-title">${name}</h5>
                            </div>
                        `;
                        cardCol.appendChild(card);
                        rowDiv.appendChild(cardCol);
                    }
                });

                attendanceList.appendChild(rowDiv);

                const membersResponse = await fetch('/api/current_members');
                const membersData = await membersResponse.json();

                const allMembers = membersData.members;
                const bigDragonLeftMembers = membersData.members.filter(member => member.category === '大混' && member.side === 'Left' && attendance[names.indexOf(member.name)] === '○');
                const bigDragonRightMembers = membersData.members.filter(member => member.category === '大混' && member.side === 'Right' && attendance[names.indexOf(member.name)] === '○');
                const smallDragonLeftMembers = membersData.members.filter(member => member.category === '小混' && member.side === 'Left' && attendance[names.indexOf(member.name)] === '○');
                const smallDragonRightMembers = membersData.members.filter(member => member.category === '小混' && member.side === 'Right' && attendance[names.indexOf(member.name)] === '○');

                // 所有今日出席的隊員
                const allPresentMembers = membersData.members.filter(member => attendance[names.indexOf(member.name)] === '○');
                // 所有不在今日出席名單中的隊員
                const allAbsentMembers = membersData.members.filter(member => attendance[names.indexOf(member.name)] !== '○');

                console.log('Big Dragon Left:', bigDragonLeftMembers);
                console.log('Big Dragon Right:', bigDragonRightMembers);
                console.log('Small Dragon Left:', smallDragonLeftMembers);
                console.log('Small Dragon Right:', smallDragonRightMembers);
                console.log('All Present Members:', allPresentMembers);
                console.log('All Absent Members:', allAbsentMembers);

                // Populate paddler options for 大龍
                populateSpecialOptions('left_0', 'right_0', allPresentMembers, allAbsentMembers);
                for (let i = 1; i <= 12; i++) {
                    populateOptions('left_' + i, 'right_' + i, bigDragonLeftMembers, bigDragonRightMembers, smallDragonLeftMembers, smallDragonRightMembers, allAbsentMembers);
                }
                populateHelmsmanOptions('left_helmsman', allPresentMembers, allAbsentMembers);

                // Populate paddler options for 小龍
                populateSpecialOptions('small_left_0', 'small_right_0', allPresentMembers, allAbsentMembers);
                for (let i = 1; i <= 8; i++) {
                    populateOptions('small_left_' + i, 'small_right_' + i, bigDragonLeftMembers, bigDragonRightMembers, smallDragonLeftMembers, smallDragonRightMembers, allAbsentMembers);
                }
                populateHelmsmanOptions('small_helmsman', allPresentMembers, allAbsentMembers);

                // 更新表格的caption中的日期
                document.getElementById('bigDragonDate').textContent = `(${selectDate})`;
                document.getElementById('smallDragonDate').textContent = `(${selectDate})`;

                loadState(selectDate);
            } catch (error) {
                console.error('Error fetching attendance data:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Populate select dropdown with members
        function populateSpecialOptions(leftId, rightId, allPresentMembers, allAbsentMembers) {
            const selectLeft = document.getElementById(leftId);
            const selectRight = document.getElementById(rightId);
            selectLeft.innerHTML = '';
            selectRight.innerHTML = '';

            const emptyOption = document.createElement('option');
            emptyOption.text = '';
            emptyOption.value = '';
            selectLeft.appendChild(emptyOption.cloneNode(true));
            selectRight.appendChild(emptyOption.cloneNode(true));

            const optgroupPresentLeft = document.createElement('optgroup');
            optgroupPresentLeft.label = '今日出席';
            selectLeft.appendChild(optgroupPresentLeft);

            const optgroupAbsentLeft = document.createElement('optgroup');
            optgroupAbsentLeft.label = '未登記出席';
            selectLeft.appendChild(optgroupAbsentLeft);

            const optgroupPresentRight = document.createElement('optgroup');
            optgroupPresentRight.label = '今日出席';
            selectRight.appendChild(optgroupPresentRight);

            const optgroupAbsentRight = document.createElement('optgroup');
            optgroupAbsentRight.label = '未登記出席';
            selectRight.appendChild(optgroupAbsentRight);

            // Populate options
            allPresentMembers.forEach(member => {
                const option = document.createElement('option');
                option.text = member.name;
                option.value = member.name;
                option.dataset.weight = member.weight;
                optgroupPresentLeft.appendChild(option.cloneNode(true));
                optgroupPresentRight.appendChild(option.cloneNode(true));
            });

            // Populate options
            allAbsentMembers.forEach(member => {
                const option = document.createElement('option');
                option.text = member.name;
                option.value = member.name;
                option.dataset.weight = member.weight;
                optgroupAbsentLeft.appendChild(option.cloneNode(true));
                optgroupAbsentRight.appendChild(option.cloneNode(true));
            });

            // Add event listeners
            selectLeft.addEventListener('change', disableSelectedOptions);
            selectRight.addEventListener('change', disableSelectedOptions);
            selectLeft.addEventListener('change', calculateWeights);
            selectRight.addEventListener('change', calculateWeights);
        }

        // Populate select dropdown with members
        function populateOptions(leftId, rightId, bigDragonLeftMembers, bigDragonRightMembers, smallDragonLeftMembers, smallDragonRightMembers, allAbsentMembers) {
            const selectLeft = document.getElementById(leftId);
            const selectRight = document.getElementById(rightId);
            selectLeft.innerHTML = '';
            selectRight.innerHTML = '';

            const emptyOption = document.createElement('option');
            emptyOption.text = '';
            emptyOption.value = '';
            selectLeft.appendChild(emptyOption.cloneNode(true));
            selectRight.appendChild(emptyOption.cloneNode(true));

            const optgroupBigLeft = document.createElement('optgroup');
            optgroupBigLeft.label = '大混 - 左';
            selectLeft.appendChild(optgroupBigLeft);

            const optgroupBigRight = document.createElement('optgroup');
            optgroupBigRight.label = '大混 - 右';
            selectRight.appendChild(optgroupBigRight);

            const optgroupSmallLeft = document.createElement('optgroup');
            optgroupSmallLeft.label = '小混 - 左';
            selectLeft.appendChild(optgroupSmallLeft);

            const optgroupSmallRight = document.createElement('optgroup');
            optgroupSmallRight.label = '小混 - 右';
            selectRight.appendChild(optgroupSmallRight);

            const optgroupOthersLeft = document.createElement('optgroup');
            optgroupOthersLeft.label = '未登記出席';
            selectLeft.appendChild(optgroupOthersLeft);

            const optgroupOthersRight = document.createElement('optgroup');
            optgroupOthersRight.label = '未登記出席';
            selectRight.appendChild(optgroupOthersRight);

            bigDragonLeftMembers.forEach(member => {
                const option = document.createElement('option');
                option.text = member.name;
                option.value = member.name;
                option.dataset.weight = member.weight;
                optgroupBigLeft.appendChild(option.cloneNode(true));
            });

            bigDragonRightMembers.forEach(member => {
                const option = document.createElement('option');
                option.text = member.name;
                option.value = member.name;
                option.dataset.weight = member.weight;
                optgroupBigRight.appendChild(option.cloneNode(true));
            });

            smallDragonLeftMembers.forEach(member => {
                const option = document.createElement('option');
                option.text = member.name;
                option.value = member.name;
                option.dataset.weight = member.weight;
                optgroupSmallLeft.appendChild(option.cloneNode(true));
            });

            smallDragonRightMembers.forEach(member => {
                const option = document.createElement('option');
                option.text = member.name;
                option.value = member.name;
                option.dataset.weight = member.weight;
                optgroupSmallRight.appendChild(option.cloneNode(true));
            });

            allAbsentMembers.forEach(member => {
                const option = document.createElement('option');
                option.text = member.name;
                option.value = member.name;
                option.dataset.weight = member.weight;
                optgroupOthersLeft.appendChild(option.cloneNode(true));
                optgroupOthersRight.appendChild(option.cloneNode(true));
            });

            // Add event listeners
            selectLeft.addEventListener('change', disableSelectedOptions);
            selectRight.addEventListener('change', disableSelectedOptions);
            selectLeft.addEventListener('change', calculateWeights);
            selectRight.addEventListener('change', calculateWeights);
        }

        // Populate select dropdown with helmsman
        function populateHelmsmanOptions(helmsmanId, allPresentMembers, allAbsentMembers) {
            const selectHelmsman = document.getElementById(helmsmanId);
            selectHelmsman.innerHTML = '';

            const emptyOption = document.createElement('option');
            emptyOption.text = '';
            emptyOption.value = '';
            selectHelmsman.appendChild(emptyOption.cloneNode(true));

            const optgroupPresent = document.createElement('optgroup');
            optgroupPresent.label = '今日出席';
            selectHelmsman.appendChild(optgroupPresent);

            const optgroupAbsent = document.createElement('optgroup');
            optgroupAbsent.label = '未登記出席';
            selectHelmsman.appendChild(optgroupAbsent);

            allPresentMembers.forEach(member => {
                const option = document.createElement('option');
                option.text = member.name;
                option.value = member.name;
                option.dataset.weight = member.weight;
                optgroupPresent.appendChild(option.cloneNode(true));
            });

            allAbsentMembers.forEach(member => {
                const option = document.createElement('option');
                option.text = member.name;
                option.value = member.name;
                option.dataset.weight = member.weight;
                optgroupAbsent.appendChild(option.cloneNode(true));
            });

            selectHelmsman.addEventListener('change', disableSelectedOptions);
        }

        // Disable selected options in other selects
        function disableSelectedOptions() {
            const allSelects = document.querySelectorAll('select');
            const selectedOptions = new Set();

            allSelects.forEach(select => {
                const selectedValue = select.value;
                if (selectedValue) {
                    selectedOptions.add(selectedValue);
                }
            });

            allSelects.forEach(select => {
                const options = select.options;
                for (let i = 0; i < options.length; i++) {
                    const option = options[i];
                    if (selectedOptions.has(option.value) && option.value !== select.value) {
                        option.disabled = true;
                    } else {
                        option.disabled = false;
                    }
                }
            });
        }

        // Calculate total weights
        function calculateWeights() {
            let leftWeight = 0;
            let rightWeight = 0;
            let smallLeftWeight = 0;
            let smallRightWeight = 0;

            const bigDragonLeftSelects = document.querySelectorAll('#bigDragonTableContainer select[id^="left_"]');
            const bigDragonRightSelects = document.querySelectorAll('#bigDragonTableContainer select[id^="right_"]');
            const smallDragonLeftSelects = document.querySelectorAll('#smallDragonTableContainer select[id^="small_left_"]');
            const smallDragonRightSelects = document.querySelectorAll('#smallDragonTableContainer select[id^="small_right_"]');

            bigDragonLeftSelects.forEach(select => {
                if (select.value) {
                    leftWeight += parseFloat(select.selectedOptions[0].dataset.weight) || 0;
                }
            });

            bigDragonRightSelects.forEach(select => {
                if (select.value) {
                    rightWeight += parseFloat(select.selectedOptions[0].dataset.weight) || 0;
                }
            });

            smallDragonLeftSelects.forEach(select => {
                if (select.value) {
                    smallLeftWeight += parseFloat(select.selectedOptions[0].dataset.weight) || 0;
                }
            });

            smallDragonRightSelects.forEach(select => {
                if (select.value) {
                    smallRightWeight += parseFloat(select.selectedOptions[0].dataset.weight) || 0;
                }
            });

            document.getElementById('leftWeight').textContent = leftWeight.toFixed(2);
            document.getElementById('rightWeight').textContent = rightWeight.toFixed(2);
            document.getElementById('smallLeftWeight').textContent = smallLeftWeight.toFixed(2);
            document.getElementById('smallRightWeight').textContent = smallRightWeight.toFixed(2);
        }

        // Populate select dropdown with dates
        async function populateDates() {
            const response = await fetch('/api/attendance');
            const data = await response.json();
            const selectDate = document.getElementById('selectDate');
            selectDate.innerHTML = '';
            data.dates.forEach(date => {
                const option = document.createElement('option');
                option.text = date;
                option.value = date;
                selectDate.appendChild(option);
            });
            // 確保日期選擇變更處理器僅設置一次
            selectDate.addEventListener('change', onDateChange);
        }

        // Save state when date changes
        function onDateChange() {
            const selectDate = document.getElementById('selectDate').value;
            if (selectDate !== currentDate) {
                getAttendance();
            }
        }

        // Save state to local storage
        function saveState(date) {
            if (!date) return;
            const state = {
                left: {},
                right: {},
                helmsman: {}
            };
            for (let i = 0; i <= 12; i++) {
                state.left[`left_${i}`] = document.getElementById(`left_${i}`).value;
                state.right[`right_${i}`] = document.getElementById(`right_${i}`).value;
            }
            state.helmsman['left_helmsman'] = document.getElementById('left_helmsman').value;

            localStorage.setItem(date, JSON.stringify(state));
        }

        // Load state from local storage
        function loadState(date) {
            const state = JSON.parse(localStorage.getItem(date));
            if (!state) return;
            for (let i = 0; i <= 12; i++) {
                document.getElementById(`left_${i}`).value = state.left[`left_${i}`] || '';
                document.getElementById(`right_${i}`).value = state.right[`right_${i}`] || '';
            }
            document.getElementById('left_helmsman').value = state.helmsman['left_helmsman'] || '';
            calculateWeights();
            disableSelectedOptions(); // 確保在加載狀態時禁用選項
        }

        // Clear table
        function clearTable(containerId) {
            if (confirm("確定要清空目前的名單嗎？")) {
                const container = document.getElementById(containerId);
                const selects = container.querySelectorAll('select');
                selects.forEach(select => {
                    select.value = '';
                });
                calculateWeights();
                disableSelectedOptions();
            }
        }

        // Export table to image
        function exportTableToImage(tableId, dragonType) {
            const tableContainer = document.getElementById(tableId);
            let selectDate = document.getElementById('selectDate').value;
            selectDate = selectDate.split('(')[0].replace(/\//g, '_').replace(/\)/g, '');
            const filename = `${selectDate}_${dragonType}.png`;
            html2canvas(tableContainer).then(canvas => {
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        // Initial load
        populateDates().then(getAttendance);
    </script>
</body>
</html>
