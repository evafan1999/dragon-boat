<!DOCTYPE html>
<html>
<head>
    <title>Dragon Boat Team Attendance</title>
    <!-- Bootstrap CSS -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
    <div class="container mt-4">
        <h1>派兜出席表</h1>
        <div class="row align-items-end">
            <div class="col-12 col-md-6">
                <label for="selectDate" class="form-label">Select Date:</label>
                <select id="selectDate" class="form-select"></select>
            </div>
            <div class="col-12 col-md-6">
                <button onclick="getAttendance()" class="btn" style="margin-top: 10px; background-color: black; color: white;">Show Attendance</button>
            </div>
        </div>
        <div class="container" style="margin-top: 10px;">
            <div class="row">
                <div class="col-sm">
                    <table class="table table-sm">
                        <caption class="caption-top">大龍</caption>
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">左</th>
                                <th scope="col">右</th>
                            </tr>
                        </thead>
                        <tbody id="paddleTableBody">
                            <tr><td>1</td><td><select class="form-select" id="left_1"></select></td><td><select class="form-select" id="right_1"></select></td></tr>
                            <tr><td>2</td><td><select class="form-select" id="left_2"></select></td><td><select class="form-select" id="right_2"></select></td></tr>
                            <tr><td>3</td><td><select class="form-select" id="left_3"></select></td><td><select class="form-select" id="right_3"></select></td></tr>
                            <tr><td>4</td><td><select class="form-select" id="left_4"></select></td><td><select class="form-select" id="right_4"></select></td></tr>
                            <tr><td>5</td><td><select class="form-select" id="left_5"></select></td><td><select class="form-select" id="right_5"></select></td></tr>
                            <tr><td>6</td><td><select class="form-select" id="left_6"></select></td><td><select class="form-select" id="right_6"></select></td></tr>
                            <tr><td>7</td><td><select class="form-select" id="left_7"></select></td><td><select class="form-select" id="right_7"></select></td></tr>
                            <tr><td>8</td><td><select class="form-select" id="left_8"></select></td><td><select class="form-select" id="right_8"></select></td></tr>
                            <tr><td>9</td><td><select class="form-select" id="left_9"></select></td><td><select class="form-select" id="right_9"></select></td></tr>
                            <tr><td>10</td><td><select class="form-select" id="left_10"></select></td><td><select class="form-select" id="right_10"></select></td></tr>
                            <tr><td>11</td><td><select class="form-select" id="left_11"></select></td><td><select class="form-select" id="right_11"></select></td></tr>
                            <tr><td>12</td><td><select class="form-select" id="left_12"></select></td><td><select class="form-select" id="right_12"></select></td></tr>
                        </tbody>
                    </table>
                </div>    
                <div class="col-sm">
                    <table class="table table-sm">
                        <caption class="caption-top">小龍</caption>
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">左</th>
                                <th scope="col">右</th>
                            </tr>
                        </thead>
                        <tbody id="smallPaddleTableBody"> 
                            <tr><td>1</td><td><select class="form-select" id="small_left_1"></select></td><td><select class="form-select" id="small_right_1"></select></td></tr>
                            <tr><td>2</td><td><select class="form-select" id="small_left_2"></select></td><td><select class="form-select" id="small_right_2"></select></td></tr>
                            <tr><td>3</td><td><select class="form-select" id="small_left_3"></select></td><td><select class="form-select" id="small_right_3"></select></td></tr>
                            <tr><td>4</td><td><select class="form-select" id="small_left_4"></select></td><td><select class="form-select" id="small_right_4"></select></td></tr>
                            <tr><td>5</td><td><select class="form-select" id="small_left_5"></select></td><td><select class="form-select" id="small_right_5"></select></td></tr>
                            <tr><td>6</td><td><select class="form-select" id="small_left_6"></select></td><td><select class="form-select" id="small_right_6"></select></td></tr>
                            <tr><td>7</td><td><select class="form-select" id="small_left_7"></select></td><td><select class="form-select" id="small_right_7"></select></td></tr>
                            <tr><td>8</td><td><select class="form-select" id="small_left_8"></select></td><td><select class="form-select" id="small_right_8"></select></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <ul id="attendanceList" class="mt-3 list-group"></ul>
    </div>
    <div class="container mt-3">
        <button onclick="window.location.href='/members'" class="btn" style="margin-bottom: 10px; background-color: black; color: white;">Member Management</button>
    </div>
    <script>
        async function getAttendance() {
            const selectDate = document.getElementById('selectDate').value;
            const response = await fetch('/api/attendance');
            const data = await response.json();

            const dates = data.dates;
            const index = dates.indexOf(selectDate);
            const names = data.names;
            const attendance = data.attendance[index];

            const attendanceList = document.getElementById('attendanceList');
            attendanceList.innerHTML = ''; // Clear previous list

            names.forEach((name, i) => {
                if (attendance[i] === '○') {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${name}: ${attendance[i]}`;
                    attendanceList.appendChild(listItem);
                }
            });

            const membersResponse = await fetch('/api/current_members');
            const membersData = await membersResponse.json();

            const bigDragonLeftMembers = membersData.members.filter(member => member.category === '大混' && member.side === 'Left' && attendance[names.indexOf(member.name)] === '○');
            const bigDragonRightMembers = membersData.members.filter(member => member.category === '大混' && member.side === 'Right' && attendance[names.indexOf(member.name)] === '○');
            const smallDragonLeftMembers = membersData.members.filter(member => member.category === '小混' && member.side === 'Left' && attendance[names.indexOf(member.name)] === '○');
            const smallDragonRightMembers = membersData.members.filter(member => member.category === '小混' && member.side === 'Right' && attendance[names.indexOf(member.name)] === '○');

            console.log('Big Dragon Left:', bigDragonLeftMembers);
            console.log('Big Dragon Right:', bigDragonRightMembers);
            console.log('Small Dragon Left:', smallDragonLeftMembers);
            console.log('Small Dragon Right:', smallDragonRightMembers);

            // Populate paddler options for 大龍
            for (let i = 1; i <= 12; i++) {
                populateOptions('left_' + i, 'right_' + i, bigDragonLeftMembers, bigDragonRightMembers, smallDragonLeftMembers, smallDragonRightMembers);
            }

            // Populate paddler options for 小龍
            for (let i = 1; i <= 8; i++) {
                populateOptions('small_left_' + i, 'small_right_' + i, bigDragonLeftMembers, bigDragonRightMembers, smallDragonLeftMembers, smallDragonRightMembers);
            }

            disableSelectedOptions();
        }

        function populateOptions(leftId, rightId, bigDragonLeftMembers, bigDragonRightMembers, smallDragonLeftMembers, smallDragonRightMembers) {
            const selectLeft = document.getElementById(leftId);
            const selectRight = document.getElementById(rightId);
            selectLeft.innerHTML = '';
            selectRight.innerHTML = '';

            const emptyOption = document.createElement('option');
            emptyOption.text = '';
            emptyOption.value = '';
            selectLeft.appendChild(emptyOption.cloneNode(true));
            selectRight.appendChild(emptyOption.cloneNode(true));

            const optgroupBigLeft = document.createElement('optgroup');
            optgroupBigLeft.label = '大混 - 左';
            selectLeft.appendChild(optgroupBigLeft);

            const optgroupBigRight = document.createElement('optgroup');
            optgroupBigRight.label = '大混 - 右';
            selectRight.appendChild(optgroupBigRight);

            const optgroupSmallLeft = document.createElement('optgroup');
            optgroupSmallLeft.label = '小混 - 左';
            selectLeft.appendChild(optgroupSmallLeft);

            const optgroupSmallRight = document.createElement('optgroup');
            optgroupSmallRight.label = '小混 - 右';
            selectRight.appendChild(optgroupSmallRight);

            bigDragonLeftMembers.forEach(member => {
                const option = document.createElement('option');
                option.text = member.name;
                option.value = member.name;
                optgroupBigLeft.appendChild(option.cloneNode(true));
            });

            bigDragonRightMembers.forEach(member => {
                const option = document.createElement('option');
                option.text = member.name;
                option.value = member.name;
                optgroupBigRight.appendChild(option.cloneNode(true));
            });

            smallDragonLeftMembers.forEach(member => {
                const option = document.createElement('option');
                option.text = member.name;
                option.value = member.name;
                optgroupSmallLeft.appendChild(option.cloneNode(true));
            });

            smallDragonRightMembers.forEach(member => {
                const option = document.createElement('option');
                option.text = member.name;
                option.value = member.name;
                optgroupSmallRight.appendChild(option.cloneNode(true));
            });

            selectLeft.addEventListener('change', disableSelectedOptions);
            selectRight.addEventListener('change', disableSelectedOptions);
        }

        function disableSelectedOptions() {
            const allSelects = document.querySelectorAll('select');
            const selectedOptions = new Set();

            allSelects.forEach(select => {
                const selectedValue = select.value;
                if (selectedValue) {
                    selectedOptions.add(selectedValue);
                }
            });

            allSelects.forEach(select => {
                const options = select.options;
                for (let i = 0; i < options.length; i++) {
                    const option = options[i];
                    if (selectedOptions.has(option.value) && option.value !== select.value) {
                        option.disabled = true;
                    } else {
                        option.disabled = false;
                    }
                }
            });
        }

        // Populate select dropdown with dates
        async function populateDates() {
            const response = await fetch('/api/attendance');
            const data = await response.json();
            const selectDate = document.getElementById('selectDate');
            selectDate.innerHTML = '';
            data.dates.forEach(date => {
                const option = document.createElement('option');
                option.text = date;
                option.value = date;
                selectDate.appendChild(option);
            });
        }

        // Initial load
        populateDates().then(getAttendance);
    </script>    
</body>
</html>
