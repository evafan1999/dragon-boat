<!DOCTYPE html>
<html>
<head>
    <title>Dragon Boat Team Attendance</title>
    <!-- Bootstrap JS and dependencies -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
    <div class="container mt-4">
        <h1>派兜出席表</h1>
        <div class="row align-items-end">
            <div class="col-12 col-md-6">
                <label for="selectDate" class="form-label">Select Date:</label>
                <select id="selectDate" class="form-select"></select>
            </div>
            <div class="col-12 col-md-6">
                <button onclick="getAttendance()" class="btn" style="margin-top: 10px; background-color: black; color: white;">Show Attendance</button>
            </div>
        </div>
        <div class="container" style="margin-top: 10px;">
            <!-- <h4>Paddle Arrangement</h4> -->
            <div class="row">
                <div class="col-sm">
                    <table class="table table-sm">
                        <caption class="caption-top">
                            大龍
                        </caption>
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">左</th>
                                <th scope="col">右</th>
                            </tr>
                        </thead>
                        <tbody id="paddleTableBody">
                            <!-- Rows for 3*12 table -->
                            <tr><td>1</td><td><select class="form-select" id="left_1"></select></td><td><select class="form-select" id="right_1"></select></td></tr>
                            <tr><td>2</td><td><select class="form-select" id="left_2"></select></td><td><select class="form-select" id="right_2"></select></td></tr>
                            <tr><td>3</td><td><select class="form-select" id="left_3"></select></td><td><select class="form-select" id="right_3"></select></td></tr>
                            <tr><td>4</td><td><select class="form-select" id="left_4"></select></td><td><select class="form-select" id="right_4"></select></td></tr>
                            <tr><td>5</td><td><select class="form-select" id="left_5"></select></td><td><select class="form-select" id="right_5"></select></td></tr>
                            <tr><td>6</td><td><select class="form-select" id="left_6"></select></td><td><select class="form-select" id="right_6"></select></td></tr>
                            <tr><td>7</td><td><select class="form-select" id="left_7"></select></td><td><select class="form-select" id="right_7"></select></td></tr>
                            <tr><td>8</td><td><select class="form-select" id="left_8"></select></td><td><select class="form-select" id="right_8"></select></td></tr>
                            <tr><td>9</td><td><select class="form-select" id="left_9"></select></td><td><select class="form-select" id="right_9"></select></td></tr>
                            <tr><td>10</td><td><select class="form-select" id="left_10"></select></td><td><select class="form-select" id="right_10"></select></td></tr>
                            <tr><td>11</td><td><select class="form-select" id="left_11"></select></td><td><select class="form-select" id="right_11"></select></td></tr>
                            <tr><td>12</td><td><select class="form-select" id="left_12"></select></td><td><select class="form-select" id="right_12"></select></td></tr>
                        </tbody>
                    </table>
                </div>    
                <div class="col-sm">
                    <table class="table table-sm">
                        <caption class="caption-top">
                            小龍
                        </caption>
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">左</th>
                                <th scope="col">右</th>
                            </tr>
                        </thead>
                        <tbody id="smallPaddleTableBody"> 
                            <tr><td>1</td><td><select class="form-select" id="small_left_1"></select></td><td><select class="form-select" id="small_right_1"></select></td></tr>
                            <tr><td>2</td><td><select class="form-select" id="small_left_2"></select></td><td><select class="form-select" id="small_right_2"></select></td></tr>
                            <tr><td>3</td><td><select class="form-select" id="small_left_3"></select></td><td><select class="form-select" id="small_right_3"></select></td></tr>
                            <tr><td>4</td><td><select class="form-select" id="small_left_4"></select></td><td><select class="form-select" id="small_right_4"></select></td></tr>
                            <tr><td>5</td><td><select class="form-select" id="small_left_5"></select></td><td><select class="form-select" id="small_right_5"></select></td></tr>
                            <tr><td>6</td><td><select class="form-select" id="small_left_6"></select></td><td><select class="form-select" id="small_right_6"></select></td></tr>
                            <tr><td>7</td><td><select class="form-select" id="small_left_7"></select></td><td><select class="form-select" id="small_right_7"></select></td></tr>
                            <tr><td>8</td><td><select class="form-select" id="small_left_8"></select></td><td><select class="form-select" id="small_right_8"></select></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <ul id="attendanceList" class="mt-3 list-group"></ul>
    </div>
    <div class="container mt-3">
        <button onclick="window.location.href='/members'" class="btn" style="margin-bottom: 10px; background-color: black; color: white;">Member Management</button>
    </div>
    <script>
        function getAttendance() {
            const selectDate = document.getElementById('selectDate').value;
    
            // Check if both paddler tables have finished loading
            let leftTablesLoaded = true;
            let rightTablesLoaded = true;
    
            for (let i = 1; i <= 12; i++) {
                if (document.getElementById('left_' + i).options.length === 0 || document.getElementById('right_' + i).options.length === 0) {
                    leftTablesLoaded = false;
                    break;
                }
            }
    
            for (let i = 1; i <= 8; i++) {
                if (document.getElementById('small_left_' + i).options.length === 0 || document.getElementById('small_right_' + i).options.length === 0) {
                    rightTablesLoaded = false;
                    break;
                }
            }
    
            if (leftTablesLoaded && rightTablesLoaded) {
                alert('Loading successful!');
            }
    
            fetch('/api/attendance')
                .then(response => response.json())
                .then(data => {
                    const dates = data.dates;
                    const index = dates.indexOf(selectDate);
                    const names = data.names;
                    const attendance = data.attendance[index];
    
                    const attendanceList = document.getElementById('attendanceList');
                    attendanceList.innerHTML = ''; // Clear previous list
    
                    names.forEach((name, i) => {
                        if (attendance[i] === '○') {
                            const listItem = document.createElement('li');
                            listItem.textContent = `${name}: ${attendance[i]}`;
                            attendanceList.appendChild(listItem);
                        }
                    });
    
                    fetch('/api/current_members')
                        .then(response => response.json())
                        .then(data => {
                            // Populate paddler options for both 大龍 and 小龍
                            for (let i = 1; i <= 12; i++) {
                                populateOptions('left_' + i, 'right_' + i, names, attendance, data.members);
                            }
    
                            // Populate paddler options for 小龍
                            for (let i = 1; i <= 8; i++) {
                                populateOptions('small_left_' + i, 'small_right_' + i, names, attendance, data.members);
                            }
                        });
                });
        }
    
        function populateOptions(leftId, rightId, names, attendance, members) {
            const selectLeft = document.getElementById(leftId);
            const selectRight = document.getElementById(rightId);
            selectLeft.innerHTML = '';
            selectRight.innerHTML = '';

            const emptyOption = document.createElement('option');
            emptyOption.text = '';
            emptyOption.value = '';
            selectLeft.appendChild(emptyOption.cloneNode(true));
            selectRight.appendChild(emptyOption.cloneNode(true));

            const selectedNamesLeft = [];
            const selectedNamesRight = [];

            names.forEach((name, j) => {
                if (attendance[j] === '○') {
                    const member = members.find(member => member.name === name);
                    if (member) {
                        const option = document.createElement('option');
                        option.text = name;
                        if (member.side === 'Left') {
                            selectLeft.appendChild(option);
                            if (selectedNamesLeft.includes(name)) {
                                option.disabled = true;
                            }
                        } else if (member.side === 'Right') {
                            selectRight.appendChild(option);
                            if (selectedNamesRight.includes(name)) {
                                option.disabled = true;
                            }
                        }
                    }
                }
            });

            selectLeft.addEventListener('change', (event) => {
                const selectedName = event.target.value;
                if (selectedName !== '') {
                    selectedNamesLeft.push(selectedName);
                    selectRight.querySelectorAll('option').forEach(option => {
                        if (option.text === selectedName) {
                            option.disabled = true;
                        }
                    });
                }
            });

            selectRight.addEventListener('change', (event) => {
                const selectedName = event.target.value;
                if (selectedName !== '') {
                    selectedNamesRight.push(selectedName);
                    selectLeft.querySelectorAll('option').forEach(option => {
                        if (option.text === selectedName) {
                            option.disabled = true;
                        }
                    });
                }
            });
        }
        // Populate select dropdown with dates
        fetch('/api/attendance')
            .then(response => response.json())
            .then(data => {
                const selectDate = document.getElementById('selectDate');
                selectDate.innerHTML = '';
                data.dates.forEach(date => {
                    const option = document.createElement('option');
                    option.text = date;
                    option.value = date;
                    selectDate.appendChild(option);
                });
            });
    
        getAttendance(); // To populate the initial attendance list and paddler arrangement
    </script>    
</body>
</html>